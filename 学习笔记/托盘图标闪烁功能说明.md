# 🔆 托盘图标闪烁功能 - 使用指南

## 📖 功能概述

托盘图标闪烁是一种常见的视觉提醒方式，用于在应用最小化到托盘时吸引用户注意。

**典型应用场景：**
- 📧 收到新消息（如微信、QQ）
- 📝 添加了新任务
- ⚠️ 重要事件提醒
- 🔔 后台任务完成

---

## 🎯 本项目实现

### 自动触发场景

**当窗口隐藏到托盘时，以下操作会自动触发闪烁：**
1. 添加新任务
2. （可扩展）收到通知
3. （可扩展）任务到期提醒

### 手动测试功能

应用提供了手动测试按钮，方便测试闪烁效果：
- 🔆 **开始闪烁**：点击后托盘图标开始闪烁
- 🔅 **停止闪烁**：点击后停止闪烁

---

## 🚀 快速体验

### 方法 1：自动触发测试

1. 启动应用 `npm start`
2. 点击窗口的最小化按钮（或关闭按钮）
3. 应用隐藏到系统托盘
4. 在任务输入框中输入任务并添加
5. 观察系统托盘图标开始闪烁 ✨
6. 点击托盘图标恢复窗口，闪烁自动停止

### 方法 2：手动测试

1. 启动应用 `npm start`
2. 在 IPC 功能演示区找到"托盘图标闪烁"
3. 点击 🔆 **开始闪烁** 按钮
4. 最小化窗口到托盘
5. 观察托盘图标闪烁效果
6. 点击 🔅 **停止闪烁** 按钮或恢复窗口

---

## 💻 技术实现

### 1. 主进程实现（main.js）

```javascript
// 闪烁状态管理
let isFlashing = false;
let flashInterval = null;
let normalIcon = null;
let emptyIcon = null;

// 开始闪烁
function startTrayFlashing() {
  if (isFlashing || tray === null) {
    return;
  }

  isFlashing = true;
  normalIcon = tray.getImage();  // 保存当前图标
  emptyIcon = nativeImage.createEmpty();  // 创建空图标
  
  let showIcon = false;
  flashInterval = setInterval(() => {
    if (tray) {
      // 每500ms切换一次图标
      tray.setImage(showIcon ? normalIcon : emptyIcon);
      showIcon = !showIcon;
    }
  }, 500);
}

// 停止闪烁
function stopTrayFlashing() {
  if (!isFlashing) return;
  
  clearInterval(flashInterval);
  if (tray && normalIcon) {
    tray.setImage(normalIcon);  // 恢复正常图标
  }
  isFlashing = false;
}
```

### 2. IPC 通信

**注册 IPC 监听器：**
```javascript
// main.js
ipcMain.on('tray:start-flashing', () => {
  startTrayFlashing();
});

ipcMain.on('tray:stop-flashing', () => {
  stopTrayFlashing();
});
```

**暴露 API（preload.js）：**
```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  startTrayFlashing: () => {
    ipcRenderer.send('tray:start-flashing');
  },
  
  stopTrayFlashing: () => {
    ipcRenderer.send('tray:stop-flashing');
  }
});
```

### 3. 渲染进程使用

**自动触发：**
```javascript
// renderer.js - 添加任务时
function addTask() {
  // ... 添加任务逻辑 ...
  
  // 如果窗口隐藏，触发闪烁
  if (document.hidden) {
    window.electronAPI.startTrayFlashing();
  }
}
```

**手动触发：**
```javascript
// 开始闪烁
document.getElementById('start-flash-btn').addEventListener('click', () => {
  window.electronAPI.startTrayFlashing();
});

// 停止闪烁
document.getElementById('stop-flash-btn').addEventListener('click', () => {
  window.electronAPI.stopTrayFlashing();
});
```

### 4. 自动停止闪烁

```javascript
// main.js - 窗口显示时自动停止
function showWindow() {
  if (mainWindow) {
    mainWindow.show();
    mainWindow.focus();
    stopTrayFlashing();  // 自动停止闪烁
  }
}
```

---

## 🎨 工作原理

### 闪烁机制

```
开始闪烁
    ↓
保存当前图标
    ↓
创建空图标（透明）
    ↓
每 500ms 切换一次：
    正常图标 ⇄ 空图标
    ↓
视觉效果：图标闪烁
    ↓
窗口显示时停止
    ↓
恢复正常图标
```

### 状态管理

- `isFlashing`: 是否正在闪烁
- `flashInterval`: 定时器 ID
- `normalIcon`: 正常图标的副本
- `emptyIcon`: 空（透明）图标

### 闪烁频率

- **默认**: 500ms（每秒闪烁 2 次）
- **可调整**: 修改 `setInterval` 的参数

```javascript
// 更快闪烁（250ms - 每秒4次）
flashInterval = setInterval(() => { ... }, 250);

// 更慢闪烁（1000ms - 每秒1次）
flashInterval = setInterval(() => { ... }, 1000);
```

---

## ⚙️ 自定义配置

### 修改闪烁速度

在 `main.js` 的 `startTrayFlashing` 函数中修改：

```javascript
// 原代码
flashInterval = setInterval(() => { ... }, 500);

// 快速闪烁
flashInterval = setInterval(() => { ... }, 250);

// 慢速闪烁
flashInterval = setInterval(() => { ... }, 1000);
```

### 使用不同的闪烁图标

```javascript
// 创建红色警告图标
const alertIcon = nativeImage.createFromPath('assets/icon-alert.png');

// 在正常图标和警告图标之间切换
flashInterval = setInterval(() => {
  tray.setImage(showIcon ? normalIcon : alertIcon);
  showIcon = !showIcon;
}, 500);
```

### 添加闪烁次数限制

```javascript
function startTrayFlashing(maxFlashes = -1) {
  // maxFlashes: -1 表示无限闪烁，>0 表示闪烁次数
  
  let flashCount = 0;
  flashInterval = setInterval(() => {
    if (tray) {
      tray.setImage(showIcon ? normalIcon : emptyIcon);
      showIcon = !showIcon;
      
      if (maxFlashes > 0 && ++flashCount >= maxFlashes * 2) {
        stopTrayFlashing();
      }
    }
  }, 500);
}

// 使用：闪烁 5 次后自动停止
startTrayFlashing(5);
```

---

## 🌍 平台差异

### Windows
- ✅ **完美支持**
- 闪烁效果流畅
- 用户习惯：图标闪烁表示需要注意

### macOS
- ⚠️ **部分支持**
- 图标可以闪烁，但效果不如 Windows 明显
- 建议使用其他方式（如 badge、通知）
- macOS 用户更习惯 Dock 图标的 badge

### Linux
- ⚠️ **取决于桌面环境**
- GNOME、KDE、XFCE 等支持程度不同
- 建议测试目标桌面环境

---

## 💡 使用建议

### ✅ 推荐场景

1. **重要通知**
   - 新消息到达
   - 任务完成
   - 错误提醒

2. **用户主动操作后**
   - 添加任务
   - 文件下载完成
   - 后台任务完成

3. **配合其他提醒**
   - 闪烁 + 系统通知
   - 闪烁 + 声音提示

### ❌ 避免的场景

1. **频繁闪烁**
   - 不要对每个小事件都闪烁
   - 会让用户感到烦扰

2. **无限闪烁**
   - 应设置自动停止条件
   - 或提供明显的停止方式

3. **无明确原因**
   - 用户应该知道为什么闪烁
   - 点击后应显示原因

### 最佳实践

```javascript
// 好的实践：有明确的触发条件和停止条件
function onNewTask(task) {
  if (document.hidden) {
    // 只在窗口隐藏时闪烁
    window.electronAPI.startTrayFlashing();
    
    // 可选：3秒后自动停止
    setTimeout(() => {
      window.electronAPI.stopTrayFlashing();
    }, 3000);
  }
}

// 坏的实践：无条件频繁闪烁
function onAnyEvent() {
  window.electronAPI.startTrayFlashing(); // ❌ 太频繁
}
```

---

## 🐛 故障排除

### Q: 点击"开始闪烁"后没反应？

**可能原因：**
1. 窗口没有最小化到托盘
2. 托盘图标未创建

**解决方法：**
1. 先最小化窗口
2. 然后点击"开始闪烁"
3. 查看控制台是否有错误

### Q: 闪烁无法停止？

**可能原因：**
1. JavaScript 错误中断了停止逻辑
2. 定时器 ID 丢失

**解决方法：**
1. 重启应用
2. 检查控制台错误
3. 显示窗口会自动停止闪烁

### Q: 图标闪烁看不清楚？

**解决方法：**
1. 调整闪烁间隔（减少到 250ms）
2. 使用对比度更高的图标
3. 考虑使用不同颜色的图标切换

### Q: macOS 上闪烁效果不明显？

**解决方法：**
1. macOS 图标较小，闪烁效果不如 Windows 明显
2. 建议配合系统通知使用
3. 或在 Dock 图标上显示 badge

---

## 📊 性能考虑

### 资源消耗

- **CPU**: 极低（每秒只切换 2 次图标）
- **内存**: 极低（只保存 2 个图标实例）
- **电池**: 影响可忽略

### 优化建议

1. **使用单例模式**
   - 确保只有一个闪烁定时器

2. **及时清理**
   - 应用退出时停止闪烁
   - 窗口显示时自动停止

3. **避免内存泄漏**
   ```javascript
   // 销毁托盘时清理
   function destroyTray() {
     stopTrayFlashing();  // 先停止闪烁
     if (tray) {
       tray.destroy();
       tray = null;
     }
   }
   ```

---

## 🎓 扩展练习

### 练习 1：添加闪烁颜色

创建红色/绿色图标，实现彩色闪烁：

```javascript
const redIcon = nativeImage.createFromPath('assets/icon-red.png');
const greenIcon = nativeImage.createFromPath('assets/icon-green.png');

// 红绿闪烁
flashInterval = setInterval(() => {
  tray.setImage(showIcon ? redIcon : greenIcon);
  showIcon = !showIcon;
}, 500);
```

### 练习 2：闪烁次数计数

显示闪烁了多少次：

```javascript
let flashCount = 0;

function startTrayFlashing() {
  flashCount = 0;
  flashInterval = setInterval(() => {
    flashCount++;
    console.log('闪烁次数:', flashCount);
    // ... 闪烁逻辑 ...
  }, 500);
}
```

### 练习 3：多种闪烁模式

实现不同重要程度的闪烁：

```javascript
function flashTray(mode = 'normal') {
  const modes = {
    slow: 1000,    // 慢速闪烁（不重要）
    normal: 500,   // 正常速度
    fast: 250,     // 快速闪烁（重要）
    urgent: 100    // 紧急闪烁
  };
  
  const interval = modes[mode] || 500;
  // 使用对应间隔开始闪烁
}
```

### 练习 4：配合系统通知

闪烁 + 通知：

```javascript
function notifyWithFlash(title, body) {
  // 发送系统通知
  new Notification(title, { body });
  
  // 开始闪烁
  if (document.hidden) {
    window.electronAPI.startTrayFlashing();
  }
}
```

---

## 📚 相关资源

- [Electron Tray 文档](https://www.electronjs.org/docs/api/tray)
- [Electron nativeImage 文档](https://www.electronjs.org/docs/api/native-image)
- [03-系统托盘Tray.md](./03-系统托盘Tray.md)
- [系统托盘使用指南.md](./系统托盘使用指南.md)

---

## ✅ 功能检查清单

在实际使用前，确保：

- [ ] 托盘图标已正确创建
- [ ] 窗口最小化到托盘功能正常
- [ ] 开始闪烁功能正常
- [ ] 停止闪烁功能正常
- [ ] 窗口显示时自动停止闪烁
- [ ] 应用退出时清理闪烁定时器
- [ ] 闪烁触发条件合理
- [ ] 闪烁频率适中

---

**祝你成功实现托盘图标闪烁功能！** ✨

如有问题，请查阅相关文档或在项目中查看代码实现。

